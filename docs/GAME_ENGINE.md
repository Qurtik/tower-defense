# Игровой движок

## Базовые классы

### Game

Класс для управления всей логикой игры, включая игровой цикл, обновление состояния игры и управление объектами, такими как база, турель и враги.

**Аргументы конструктора:**

| Имя             | Описание                                                                                                                                 |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| **canvas**      | элемент `HTMLCanvasElement`, на котором будет отображаться игра                                                                          |
| **initialState**| начальное состояние игры типа `GameState`                                                                                               |
| **onStateUpdate**| callback, вызываемый при изменении состояния игры, принимает обновленное состояние типа `GameState`                                      |

**Свойства:**

| Свойство            | Тип                | Описание                                                                 |
|---------------------|--------------------|--------------------------------------------------------------------------|
| `gameState`         | `GameState`        | Текущее состояние игры                                                  |
| `prevGameState`     | `GameState`        | Предыдущее состояние игры для сравнения                                  |
| `endWaveCountdown`  | `number`          | Таймер завершения волны (10 кадров)                                     |

**Методы:**

#### `start()`
Запускает игровой процесс:
1. Генерирует рецепт новой волны через `wavesManager`
2. Сбрасывает таймер завершения волны
3. Обновляет усиленные перками характеристики (`reinforcedStats`)
4. Устанавливает состояние в `'running'`
5. Запускает игровой цикл (`gameLoop`)

#### `stop()`
Останавливает игру:
1. Отменяет анимационный фрейм (`cancelAnimationFrame`)
2. Прекращает игровой цикл

#### `gameLoop()`
Основной игровой цикл:
1. Рассчитывает deltaTime (время между кадрами)
2. Очищает canvas
3. Обновляет состояние объектов:
   - База (`base.update()`)
   - Турель (`turret.update()`)
   - Враги (`enemiesManager.update()`)
   - Перки (`perksUpdater.update()`)
4. Проверяет условия окончания:
   - Все враги убиты → пауза
   - Здоровье базы ≤ 0 → game over
5. Вызывает callback для управления состоянием компонента React при изменении состояния
6. Продолжает цикл через `requestAnimationFrame`

---

### WavesManager

Класс для управления волнами врагов. Генерирует состав волн, увеличивает сложность игры и обновляет параметры врагов.

**Аргументы конструктора:**

| Имя            | Описание                                 |
| -------------- |------------------------------------------|
| **gameState**  | текущее состояние игры типа `GameState`  |

**Методы:**

#### `startNextWave()`
Запускает новую волну врагов:
1. Увеличивает номер волны (`wave++`)
2. Уменьшает время спауна врагов (но не менее 1000мс)
3. Увеличивает общее количество врагов на +2
4. Сбрасывает счетчики убитых/созданных врагов
5. Усиливает параметры врагов (`upgradeSwarm()`)
6. Возвращает рецепт волны (`generateWaveRecipe()`)

#### `generateWaveRecipe(waveNumber: number, totalEnemies: number): EnemyType[]`
Генерирует состав волны врагов:
- Волны 1: только `imp`
- Волны 2-3: 1/3 `wraith`, остальные `imp`
- Волны 4-5: 50% `imp`, 50% `wraith`
- Волны 6-7: по 1/3 `imp`, `vampire`, `wraith`
- Волны 8+: по 25% каждого типа + `berserker`
- Перемешивает порядок врагов (`shuffleArray()`)

#### `upgradeSwarm()`
Усиливает параметры врагов:
- Увеличивает здоровье на 150% от базового за волну
- Увеличивает скорость пропорционально волне
- Увеличивает урон пропорционально волне
- Учитывает коэффициент сложности (`difficultyRatio`)
---

### EnemiesManager

Класс для управления врагами в игре. Отвечает за спаун врагов, обновление их состояния, а также за удаление мертвых врагов из списка.

**Аргументы конструктора:**

| Имя            | Описание                                                                                                                  |
| -------------- |---------------------------------------------------------------------------------------------------------------------------|
| **canvas**     | элемент `HTMLCanvasElement`, на котором происходит отрисовка врагов                                                       |
| **base**       | экземпляр объекта `Base`, который используется для вычисления начальной позиции врагов и их взаимодействия с базой игрока |
| **ctx**        | 2D контекст канваса для рисования врагов                                                                                  |
| **gameState**  | текущее состояние игры типа `GameState`                                                                                   |

**Методы:**

#### `update(currentTime: number, deltaTime: number): void`
Обновляет состояние врагов:
1. Проверяет, пора ли заспаунить нового врага (в зависимости от времени и количества врагов на волне).
2. Обновляет состояние всех врагов с помощью метода `update(deltaTime)` для каждого объекта врага.
3. Удаляет мертвых врагов из списка и обновляет количество убитых врагов.
4. Обновляет состояние всех взрывов и удаляет завершенные анимации.

#### `setWaveRecipe(recipe: EnemyType[]): void`
Устанавливает текущий рецепт волны врагов:
1. Принимает массив типов врагов для текущей волны.
2. Сбрасывает индекс спауна и очищает массив взрывов.

#### `spawnEnemy(): void`
Метод для создания нового врага:
1. Вычисляет стартовую позицию с помощью `calculateSpawnPosition()`.
2. Создает врага соответствующего типа из текущего рецепта волны.
3. Добавляет врага в массив `enemies` и увеличивает индекс спауна.

#### `calculateSpawnPosition(): {x: number, y: number}`
Вычисляет случайную позицию для спауна врага:
1. Выбирает одну из четырех сторон экрана (0-верх, 1-право, 2-низ, 3-лево).
2. Учитывает отступ от краев экрана в 50 пикселей.
3. Возвращает объект с координатами {x, y}.

---

### PerksUpdater

Класс для управления активными перками в игре. Отвечает за обновление времени действия перков, применение их эффектов и сброс состояний.

**Аргументы конструктора:**

| Имя                | Тип                | Описание                                                                 |
|--------------------|--------------------|--------------------------------------------------------------------------|
| **gameState**      | `GameState`        | Текущее состояние игры                                                  |
| **enemiesManager** | `EnemiesManager`   | Менеджер врагов для применения эффектов перков                          |

**Методы:**

#### `clearActivePerks()`
Сбрасывает все активные перки:
1. Возвращает `activePerks` в исходное состояние
2. Сбрасывает усиленные характеристики (`reinforcedStats`) к базовым значениям
3. Обнуляет внутренний таймер перков

#### `update(deltaTime: number)`
Обновляет состояние перков каждый кадр:
1. Увеличивает внутренний таймер при наличии активных перков
2. Применяет мгновенные эффекты перков (если есть)
3. Обновляет оставшееся время действия для всех перков
4. Корректирует усиленные характеристики в зависимости от активных перков
5. Сбрасывает внутренний таймер после обработки

---

### SoundManager

Класс для управления звуками и музыкой в игре. Отвечает за воспроизведение звуковых эффектов и фоновой музыки.

**Методы:**

#### `play(sound: Sound)`
Воспроизводит звуковой эффект:
1. Проверяет, включены ли звуки (`soundsEnabled`)
2. Сбрасывает текущее время воспроизведения звука
3. Запускает воспроизведение указанного звука

#### `playBackgroundMusic()`
Запускает фоновую музыку:
1. Проверяет, включена ли музыка (`musicEnabled`)
2. Сбрасывает текущее время воспроизведения
3. Запускает воспроизведение музыки с автоматическим повторением

#### `stopBackgroundMusic()`
Останавливает фоновую музыку:
1. Ставит музыку на паузу
2. Сбрасывает текущее время воспроизведения

#### `toggleMusic()`
Переключает состояние музыки:
1. Инвертирует значение `musicEnabled`
2. При включении - запускает музыку, при выключении - останавливает

#### `toggleSounds()`
Переключает состояние звуковых эффектов:
1. Инвертирует значение `soundsEnabled`

---

### WithAnimation

Абстрактный класс для объектов с анимацией. Позволяет работать с изображениями, содержащими несколько кадров анимации, а также управлять процессом анимации и отрисовки на канвасе.

**Аргументы конструктора тип `TWithAnimationOptions`:**

| Имя            | Описание                                                                                                                                 |
| -------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| **ctx**        | 2D контекст канваса для рисования                                                                                                      |
| **imageSrc**   | путь к изображению (PNG с несколькими кадрами анимации)                                                                     |
| **position**   | начальная позиция объекта на канвасе в виде объекта с координатами `{ x: number; y: number }`                                          |
| **width**      | ширина объекта (спрайта)                                                                                                                |
| **height**     | высота объекта (спрайта)                                                                                                                |
| **frames**     | объект, описывающий анимацию. Содержит: `max` — количество кадров в анимации, `hold` — количество кадров, в течение которых показывается каждый кадр анимации. (по умолчанию `3`)  |

**Методы:**

#### `animate()`
Метод для анимации спрайта. Каждые `frames.hold` кадров переключает на следующий кадр анимации. Когда все кадры пройдены, анимация начинается с первого кадра.

#### `draw(rotation = 0, offsetX = 0, offsetY = 0)`
Метод для отрисовки текущего кадра анимации на канвасе. `rotation` — угол поворота объекта (по умолчанию `0`). `offsetX` и `offsetY` — смещения по осям X и Y соответственно для точной настройки положения объекта (по умолчанию `0`).

---
## Классы игровых объектов

### Base

Класс, который описывает логику работы с базой игрока. Отвечает за восстановление брони базы с течением времени и отрисовку базы на канвасе.

**Аргументы конструктора:**

| Имя            | Описание                                 |
| -------------- |------------------------------------------|
| **ctx**        | 2D контекст канваса для рисования        |
| **gameState**  | текущее состояние игры типа `GameState`  |

**Методы:**

#### `update(deltaTime: number): void`
Метод обновления базы:
1. Уменьшает время до следующего восстановления брони (`lastRegenTime`).
2. Проверяет, нужно ли восстановить броню с помощью метода `tryTryHeal()`.
3. Отрисовывает базу на канвасе.

#### `takeDamage(damage: number): void`
Метод нанесения урона базе:
1. Активирует эффект получения урона.
2. Учитывает модификаторы урона от активных перков.
3. Уменьшает здоровье базы и фиксирует минимальное значение на 0.
4. Записывает событие урона в `gameState.baseDamageEvents`.

#### `tryTryHeal()`
Метод для проверки, нужно ли восстановить броню базы:
1. Если прошло достаточно времени с последнего восстановления брони и броня не 100% от максимума, восстанавливает броню на заданную величину (`healAmount`).
2. Обновляет время для следующего восстановления брони, используя параметр `healDelay` из состояния игры.
3. Записывает событие лечения в `gameState.baseDamageEvents`.

#### `draw()`
Метод для отрисовки базы на канвасе с текущим состоянием:
1. Проверяет возможность восстановления здоровья.
2. Отрисовывает изображение базы.
3. При активном уроне добавляет эффект красной вспышки.

#### `drawFlashEffect()`
Приватный метод для отрисовки эффекта повреждения:
1. Рисует полупрозрачный красный круг поверх базы.
2. Использует композитинг 'source-atop' для смешивания цветов.

---

### Turret

Класс, который описывает логику работы с турелью игрока. Турель находит цели (врагов), поворачивается к ним и стреляет, если прошло достаточно времени с последнего выстрела.

**Аргументы конструктора:**

| Имя            | Описание                                 |
| -------------- |------------------------------------------|
| **ctx**        | 2D контекст канваса для рисования        |
| **gameState**  | текущее состояние игры типа `GameState`  |

**Свойства:**

| Свойство         | Тип                | Описание                              |
|------------------|--------------------|---------------------------------------|
| `bullets`       | `Bullet[]`        | Массив активных пуль                  |
| `target`        | `Enemy \| null`   | Текущая цель турели                   |

**Методы:**

#### `update(deltaTime: number, enemies: Enemy[])`
Метод обновления турели:
1. Обновляет состояние всех пуль (`updateBullets()`)
2. Уменьшает время до следующего выстрела (`lastShotTime`)
3. Ищет новую цель если текущая уничтожена или вне радиуса (`findTarget()`)
4. Обновляет состояние радара (`radar.update()`)
5. Пытается произвести выстрел если есть цель (`tryShoot()`)
6. Отрисовывает турель и пули (`draw()`)

#### `isInRange(enemy: Enemy): boolean`
Проверяет находится ли враг в радиусе поражения:
1. Вычисляет расстояние до врага
2. Сравнивает с усиленным перком радиусом из `reinforcedStats`

#### `findTarget(enemies: Enemy[])`
Находит новую цель для атаки:
1. Фильтрует живых видимых врагов в радиусе
2. Сортирует по расстоянию (ближайшие первыми)
3. Выбирает ближайшего врага как цель

#### `rotateToTarget()`
Поворачивает турель к текущей цели:
1. Вычисляет угол между турелью и целью
2. Обновляет свойство `rotation`

#### `tryShoot()`
Проверяет возможность выстрела:
1. Учитывает модификаторы от активных перков
2. Если время пришло - поворачивается и стреляет
3. Сбрасывает таймер выстрела

#### `shoot()`
Создает новую пулю:
1. Добавляет пулю в массив `bullets`
2. Учитывает усиленный перком урон из `reinforcedStats`
3. Воспроизводит звук выстрела

#### `updateBullets()`
Обновляет состояние пуль:
1. Вызывает `update()` для каждой пули
2. Удаляет пули с флагом `shouldRemove`

#### `draw()`
Отрисовывает турель и пули:
1. Рисует турель с учетом текущего поворота
2. Отрисовывает все активные пули

---

### Enemy

Класс, который описывает логику работы с врагом в игре. Враг может двигаться к базе, атаковать её, получать урон и умирать.

**Аргументы конструктора:**

| Имя            | Описание                                                                         |
| -------------- |----------------------------------------------------------------------------------|
| **ctx**        | 2D контекст канваса для рисования                                                |
| **startPos**   | начальная позиция врага в виде объекта с координатами `{ x: number; y: number }` |
| **target**     | объект типа `Base`, на который направлен враг (цель)                             |
| **gameState**  | текущее состояние игры типа `GameState`                                          |
| **sprite**     | путь к изображению спрайта врага                                                 |
| **spriteWidth**| ширина спрайта в пикселях                                                        |
| **spriteHeight**| высота спрайта в пикселях                                                       |
| **explosions** | массив для хранения эффектов взрывов                                             |


**Методы:**

#### `update(deltaTime: number)`
Метод обновления состояния врага:
1. Обновляет анимацию с помощью метода `draw()`
2. Уменьшает время до следующей атаки (`lastAttackTime`)
3. Вычисляет расстояние до цели и двигает врага к ней (метод `move()`)
4. Если враг находится в радиусе атаки, вызывает метод `tryAttack()` для возможного нанесения урона
5. Проверяет видимость врага в зависимости от расстояния до базы

#### `takeDamage(damage: number)`
Метод для получения урона врагом:
1. Активирует эффект мигания
2. Уменьшает здоровье врага
3. При активном перке "вампиризм" восстанавливает здоровье базы
4. При смерти врага:
    - Увеличивает счетчик убитых врагов
    - Воспроизводит звук взрыва
    - Создает эффект взрыва

#### `move()`
Метод для движения врага в сторону базы:
1. Вычисляет угол направления к базе
2. Учитывает модификаторы скорости от активных перков
3. Обновляет позицию врага

#### `tryAttack()`
Метод для проверки возможности атаки:
Если прошло достаточно времени с последней атаки (по параметру `timeBetweenAttacks`), вызывает метод `attack()`.

#### `attack()`
Метод для атаки базы:
1. Снимает эффект невидимости при атаке
2. Наносит урон базе (`gameState.baseHealth`)

#### `draw()`
Метод для отрисовки врага на канвасе:
1. Вычисляет угол поворота в сторону базы
2. Учитывает прозрачность при невидимости и мигании
3. Вызывает родительский метод отрисовки с учетом поворота и прозрачности

---

### Bullet

Класс, который описывает логику работы с пулями, выпущенными из турели. Пуля двигается к своей цели (врагу), поворачивается в её сторону, наносит урон и удаляется, если достигла цели.

**Аргументы конструктора:**

| Имя            | Описание                                                                                                                                               |
| -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| **ctx**        | 2D контекст канваса для рисования                                                                                                                     |
| **position**   | начальная позиция пули в виде объекта с координатами `{ x: number; y: number }`                                                                    |
| **target**     | объект типа `Enemy`, на который направлена пуля                                                                                                      |
| **damage**     | урон, который пуля наносит при попадании в цель                                                                                                      |

**Методы:**

#### `calculateAngle()`
Метод для вычисления угла поворота пули в сторону цели. Используется для точной траектории движения пули.

#### `update()`
Метод для обновления состояния пули:
1. Если флаг `shouldRemove` установлен в `true`, пуля удаляется.
2. Пуля анимируется с помощью метода `animate()`.
3. Если пуля ещё не достигла цели, она вычисляет новый угол и продолжает движение в сторону цели.
4. Если пуля достигает цели (расстояние до неё меньше 10 пикселей), вызывается метод `takeDamage()` у цели, и пуля помечается для удаления.

#### `move()`
Метод для перемещения пули по траектории:
1. Вычисляется скорость пули по осям X и Y, основываясь на угле к цели.
2. Пуля двигается, обновляя свою позицию.

#### `draw()`
Метод для отрисовки пули на канвасе. Пуля отрисовывается с учётом её угла поворота.

---

### Radar

Класс, который описывает логику работы радара в игре. Радар отображает область поиска врагов и подсвечивает их в зависимости от расстояния до игрока и их текущего состояния.

**Аргументы конструктора:**

| Имя            | Описание                                 |
| -------------- |------------------------------------------|
| **ctx**        | 2D контекст канваса для рисования        |
| **gameState**  | текущее состояние игры типа `GameState`  |

**Методы:**

#### `update(deltaTime: number, target: Enemy | null, enemies: Enemy[])`
Метод обновления состояния радара:
1. Вращает анимацию радара, увеличивая угол вращения (`angle`) на основе скорости пульсации (`pulseSpeed`).
2. Для каждого врага в пределах радиуса радара подсвечивает его, если он находится в пределах радиуса обнаружения.
3. Вызывает метод для отрисовки радара и всех врагов, находящихся в зоне действия.

#### `drawRadar()`
Метод для отрисовки самой области радара:
1. Рисуется внешний круг (радиус `radarRange`).
2. Рисуется пульсирующий сектор, который имитирует активный луч радара.
3. Рисуются дополнительные кольца, которые уменьшаются по прозрачности в зависимости от радиуса.

#### `drawEnemyHighlight(enemy: Enemy)`
Метод для подсветки врагов в радиусе действия радара:
1. Подсвечивает врагов с пульсацией (используя синусоидальную функцию для анимации).
2. Если враг является текущей целью, его подсветка будет красной, в противном случае — оранжевой.

---

### Explosion

Класс для создания и управления анимацией взрыва. Наследуется от `WithAnimation`.

**Аргументы конструктора:**

| Имя            | Тип                        | Описание                                                                         |
|----------------|----------------------------|----------------------------------------------------------------------------------|
| **ctx**        | `CanvasRenderingContext2D` | 2D контекст канваса для отрисовки                                               |
| **startPos**   | `{x: number, y: number}`   | начальная позиция взрыва в виде объекта с координатами                          |

**Особенности:**
- Использует спрайт взрыва размером 64x64 пикселя
- Анимация состоит из 16 кадров с задержкой в 6 кадров между сменами спрайтов

**Методы:**

#### `update()`
Обновляет состояние взрыва:
1. Прогрессирует анимацию (переключает кадры)
2. Отрисовывает текущий кадр анимации на canvas

