# Игровой движок

## Базовые классы

### Game

Класс для управления всей логикой игры, включая игровой цикл, обновление состояния игры и управление объектами, такими как база, турель и враги.

**Аргументы конструктора:**

| Имя             | Описание                                                                                                                                 |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| **canvas**      | элемент `HTMLCanvasElement`, на котором будет отображаться игра                                                                          |
| **initialState**| начальное состояние игры типа `GameState`                                                                                               |
| **onStateUpdate**| callback, вызываемый при изменении состояния игры, принимает обновленное состояние типа `GameState`                                      |

**Методы:**

#### `start()`
Запускает игровой процесс, начиная с первой волны и устанавливая состояние игры в `'running'`. Также запускает игровой цикл.

#### `stop()`
Останавливает игровой цикл и отменяет все текущие анимации.

#### `gameLoop()`
Метод для запуска основного игрового цикла. Обновляет состояние всех объектов (базы, турели, врагов) и проверяет состояние игры, включая завершение волны или окончание игры.

---

### WavesManager

Класс для управления волнами врагов, который обновляет состояние игры и параметры врагов с каждым новым раундом. Отвечает за увеличение сложности игры по мере прохождения волн.

**Аргументы конструктора:**

| Имя            | Описание                                 |
| -------------- |------------------------------------------|
| **gameState**  | текущее состояние игры типа `GameState`  |

**Методы:**

#### `startNextWave()`
Запускает следующую волну врагов:
1. Увеличивает номер текущей волны.
2. Уменьшает время спауна врагов (если оно больше 1000) для повышения сложности.
3. Увеличивает общее количество врагов в текущей волне.
4. Сбрасывает количество убитых и созданных врагов в текущей волне.
5. Вызывает метод `upgradeSwarm()` для улучшения параметров врагов в соответствии с увеличением сложности.

#### `upgradeSwarm()`
Увеличивает параметры врагов (здоровье, скорость, урон) с каждым новым уровнем сложности, основанным на текущей волне и коэффициенте сложности.

---

### EnemiesManager

Класс для управления врагами в игре. Отвечает за спаун врагов, обновление их состояния, а также за удаление мертвых врагов из списка.

**Аргументы конструктора:**

| Имя            | Описание                                                                                                                  |
| -------------- |---------------------------------------------------------------------------------------------------------------------------|
| **canvas**     | элемент `HTMLCanvasElement`, на котором происходит отрисовка врагов                                                       |
| **base**       | экземпляр объекта `Base`, который используется для вычисления начальной позиции врагов и их взаимодействия с базой игрока |
| **ctx**        | 2D контекст канваса для рисования врагов                                                                                  |
| **gameState**  | текущее состояние игры типа `GameState`                                                                                   |

**Методы:**

#### `update(currentTime: number, deltaTime: number): void`
Обновляет состояние врагов:
1. Проверяет, пора ли заспаунить нового врага (в зависимости от времени и количества врагов на волне).
2. Обновляет состояние всех врагов с помощью метода `update(deltaTime)` для каждого объекта врага.
3. Удаляет мертвых врагов из списка и обновляет количество убитых врагов.

#### `spawnEnemy()`
Метод для создания нового врага и добавления его в массив `enemies`. Враг создается в случайной позиции на одной из сторон канваса.

#### `calculateSpawnPosition()`
Вычисляет случайную позицию для спауна врага, выбирая одну из четырех сторон экрана. Отступ от краев экрана составляет 50 пикселей.

---

### WithAnimation

Абстрактный класс для объектов с анимацией. Позволяет работать с изображениями, содержащими несколько кадров анимации, а также управлять процессом анимации и отрисовки на канвасе.

**Аргументы конструктора тип `TWithAnimationOptions`:**

| Имя            | Описание                                                                                                                                 |
| -------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| **ctx**        | 2D контекст канваса для рисования                                                                                                      |
| **imageSrc**   | путь к изображению (PNG с несколькими кадрами анимации)                                                                     |
| **position**   | начальная позиция объекта на канвасе в виде объекта с координатами `{ x: number; y: number }`                                          |
| **width**      | ширина объекта (спрайта)                                                                                                                |
| **height**     | высота объекта (спрайта)                                                                                                                |
| **frames**     | объект, описывающий анимацию. Содержит: `max` — количество кадров в анимации, `hold` — количество кадров, в течение которых показывается каждый кадр анимации. (по умолчанию `3`)  |

**Методы:**

#### `animate()`
Метод для анимации спрайта. Каждые `frames.hold` кадров переключает на следующий кадр анимации. Когда все кадры пройдены, анимация начинается с первого кадра.

#### `draw(rotation = 0, offsetX = 0, offsetY = 0)`
Метод для отрисовки текущего кадра анимации на канвасе. `rotation` — угол поворота объекта (по умолчанию `0`). `offsetX` и `offsetY` — смещения по осям X и Y соответственно для точной настройки положения объекта (по умолчанию `0`).

---
## Классы игровых объектов

### Base

Класс, который описывает логику работы с базой игрока. Отвечает за восстановление брони базы с течением времени и отрисовку базы на канвасе.

**Аргументы конструктора:**

| Имя            | Описание                                 |
| -------------- |------------------------------------------|
| **ctx**        | 2D контекст канваса для рисования        |
| **gameState**  | текущее состояние игры типа `GameState`  |

**Методы:**

#### `update(deltaTime: number): void`
Метод обновления базы:
1. Уменьшает время до следующего восстановления брони (`lastRegenTime`).
2. Проверяет, нужно ли восстановить броню с помощью метода `tryTryHeal()`.
3. Отрисовывает базу на канвасе.

#### `tryTryHeal()`
Метод для проверки, нужно ли восстановить броню базы:
1. Если прошло достаточно времени с последнего восстановления брони и броня не 100% от максимума, восстанавливает броню на заданную величину (`healAmount`).
2. Обновляет время для следующего восстановления брони, используя параметр `healDelay` из состояния игры.

#### `draw()`
Метод для отрисовки базы на канвасе с текущим состоянием.

---

### Turret

Класс, который описывает логику работы с турелью игрока. Турель находит цели (врагов), поворачивается к ним и стреляет, если прошло достаточно времени с последнего выстрела.

**Аргументы конструктора:**

| Имя            | Описание                                 |
| -------------- |------------------------------------------|
| **ctx**        | 2D контекст канваса для рисования        |
| **gameState**  | текущее состояние игры типа `GameState`  |

**Методы:**

#### `update(deltaTime: number, enemies: Enemy[])`
Метод обновления турели:
1. Обновляет состояние всех пуль с помощью метода `updateBullets()`.
2. Проверяет время до следующего выстрела (`lastShotTime`) и уменьшает его.
3. Если турель не имеет цели или цель уничтожена, ищет новую цель с помощью метода `findTarget()`.
4. Если цель найдена, проверяет возможность выстрела через метод `tryShoot()` и вызывает метод для отрисовки турели.

#### `isInRange(enemy: Enemy): boolean`
Метод для проверки нахождения врага в радиусе поражения турели. Вычисляется расстояние между турелью и врагом, и если оно меньше или равно радиусу поражения, возвращается `true`.

#### `findTarget(enemies: Enemy[])`
Метод для поиска новой цели для турели. Если текущая цель уничтожена или недоступна, турель ищет ближайшего врага в радиусе поражения. Враги сортируются по расстоянию от турели, и выбирается ближайший.

#### `rotateToTarget()`
Метод для поворота турели к текущей цели. Рассчитывается угол поворота на основе координат цели.

#### `tryShoot()`
Метод для проверки, можно ли выстрелить: если цель есть и прошло достаточно времени с последнего выстрела (`lastShotTime`), турель поворачивается к цели и стреляет, после чего сбрасывается время на следующий выстрел.

#### `shoot()`
Метод для создания новой пули и добавления её в список пуль (`bullets`). Пуля создается с параметрами позиции турели, цели (врага) и урона турели.

#### `updateBullets()`
Метод для обновления состояния всех пуль:
1. Для каждой пули вызывается метод `update()`.
2. Если пуля должна быть удалена (например, она достигла цели или цель уничтожена), она удаляется из массива `bullets`.

#### `draw()`
Метод для отрисовки турели и всех её пуль:
1. Турель отрисовывается на основе текущей позиции и угла поворота.
2. Каждая пуля из массива `bullets` отрисовывается с помощью метода `draw()`.

---

### Enemy

Класс, который описывает логику работы с врагом в игре. Враг может двигаться к базе, атаковать её, получать урон и умирать.

**Аргументы конструктора:**

| Имя            | Описание                                                                         |
| -------------- |----------------------------------------------------------------------------------|
| **ctx**        | 2D контекст канваса для рисования                                                |
| **startPos**   | начальная позиция врага в виде объекта с координатами `{ x: number; y: number }` |
| **target**     | объект типа `Base`, на который направлен враг (цель)                             |
| **gameState**  | текущее состояние игры типа `GameState`                                          |

**Методы:**

#### `update(deltaTime: number)`
Метод обновления состояния врага:
1. Обновляет анимацию с помощью метода `draw()`.
2. Уменьшает время до следующей атаки (`lastAttackTime`).
3. Вычисляет расстояние до цели и двигает врага к ней (метод `move()`). Если враг находится в радиусе атаки, вызывает метод `tryAttack()` для возможного нанесения урона.

#### `takeDamage(damage: number)`
Метод для получения урона врагом. Если здоровье врага падает до нуля, увеличивает счетчик убитых врагов в `gameState`.

#### `move()`
Метод для движения врага в сторону базы. Враг поворачивается в сторону базы и начинает двигаться с заданной скоростью.

#### `tryAttack()`
Метод для проверки возможности атаки:
Если прошло достаточно времени с последней атаки (по параметру `timeBetweenAttacks`), вызывает метод `attack()`.

#### `attack()`
Метод для атаки базы. Наносит урон базе (`gameState.baseHealth`), уменьшая её здоровье.

#### `draw()`
Метод для отрисовки врага на канвасе. Враг поворачивается в сторону базы перед отрисовкой.

---

### Bullet

Класс, который описывает логику работы с пулями, выпущенными из турели. Пуля двигается к своей цели (врагу), поворачивается в её сторону, наносит урон и удаляется, если достигла цели.

**Аргументы конструктора:**

| Имя            | Описание                                                                                                                                               |
| -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| **ctx**        | 2D контекст канваса для рисования                                                                                                                     |
| **position**   | начальная позиция пули в виде объекта с координатами `{ x: number; y: number }`                                                                    |
| **target**     | объект типа `Enemy`, на который направлена пуля                                                                                                      |
| **damage**     | урон, который пуля наносит при попадании в цель                                                                                                      |

**Методы:**

#### `calculateAngle()`
Метод для вычисления угла поворота пули в сторону цели. Используется для точной траектории движения пули.

#### `update()`
Метод для обновления состояния пули:
1. Если флаг `shouldRemove` установлен в `true`, пуля удаляется.
2. Пуля анимируется с помощью метода `animate()`.
3. Если пуля ещё не достигла цели, она вычисляет новый угол и продолжает движение в сторону цели.
4. Если пуля достигает цели (расстояние до неё меньше 10 пикселей), вызывается метод `takeDamage()` у цели, и пуля помечается для удаления.

#### `move()`
Метод для перемещения пули по траектории:
1. Вычисляется скорость пули по осям X и Y, основываясь на угле к цели.
2. Пуля двигается, обновляя свою позицию.

#### `draw()`
Метод для отрисовки пули на канвасе. Пуля отрисовывается с учётом её угла поворота.

---

### Radar

Класс, который описывает логику работы радара в игре. Радар отображает область поиска врагов и подсвечивает их в зависимости от расстояния до игрока и их текущего состояния.

**Аргументы конструктора:**

| Имя            | Описание                                 |
| -------------- |------------------------------------------|
| **ctx**        | 2D контекст канваса для рисования        |
| **gameState**  | текущее состояние игры типа `GameState`  |

**Методы:**

#### `update(deltaTime: number, target: Enemy | null, enemies: Enemy[])`
Метод обновления состояния радара:
1. Вращает анимацию радара, увеличивая угол вращения (`angle`) на основе скорости пульсации (`pulseSpeed`).
2. Для каждого врага в пределах радиуса радара подсвечивает его, если он находится в пределах радиуса обнаружения.
3. Вызывает метод для отрисовки радара и всех врагов, находящихся в зоне действия.

#### `drawRadar()`
Метод для отрисовки самой области радара:
1. Рисуется внешний круг (радиус `radarRange`).
2. Рисуется пульсирующий сектор, который имитирует активный луч радара.
3. Рисуются дополнительные кольца, которые уменьшаются по прозрачности в зависимости от радиуса.

#### `drawEnemyHighlight(enemy: Enemy)`
Метод для подсветки врагов в радиусе действия радара:
1. Подсвечивает врагов с пульсацией (используя синусоидальную функцию для анимации).
2. Если враг является текущей целью, его подсветка будет красной, в противном случае — оранжевой.

